# 🎫 NFT Ticket Resale Integration Guide

## Complete Flow: Primary Sale → Secondary Market

### 📋 Table of Contents
1. [Primary Sale Flow](#primary-sale-flow)
2. [Current State Analysis](#current-state-analysis)
3. [Secondary Market Requirements](#secondary-market-requirements)
4. [Integration Implementation](#integration-implementation)
5. [Smart Contract Fixes](#smart-contract-fixes)
6. [Frontend Implementation](#frontend-implementation)

---

## 1️⃣ PRIMARY SALE FLOW

### User Journey
```
1. Organizer creates event → CreateEventNFT.tsx
2. Deploy custom NFT contract with mint-ticket function
3. Buyer mints ticket → MintTicketButton.tsx
4. NFT ticket minted to buyer's wallet
5. Ticket data stored on-chain
```

### Contract Structure (Generated by CreateEventNFT.tsx)

```clarity
;; Custom event contract deployed by organizer
(define-non-fungible-token {event-name}-ticket uint)

;; Mint function called by buyers
(define-public (mint-ticket)
  (let ((token-id (var-get next-token-id)))
    ;; Check availability
    (asserts! (<= token-id total-supply) err-sold-out)
    
    ;; Transfer payment to organizer
    (try! (stx-transfer? ticket-price tx-sender contract-owner))
    
    ;; Mint NFT to buyer
    (try! (nft-mint? {event-name}-ticket token-id tx-sender))
    
    ;; Increment counter
    (var-set next-token-id (+ token-id u1))
    
    (ok token-id)
  )
)

;; Transfer function (enables secondary sales)
(define-public (transfer (token-id uint) (sender principal) (recipient principal))
  (begin
    (asserts! (is-eq tx-sender sender) err-not-token-owner)
    (try! (nft-transfer? {event-name}-ticket token-id sender recipient))
    (ok true)
  )
)
```

### Minting Process (MintTicketButton.tsx)

```typescript
// 1. Check wallet connected
const userSignedIn = isUserSignedIn();

// 2. Check STX balance
const balanceCheck = await hasEnoughSTX(userAddress, ticketPrice);

// 3. Call mint-ticket function
await openContractCall({
  contractAddress: '...',
  contractName: 'event-contract',
  functionName: 'mint-ticket',
  functionArgs: [],
  postConditions: [
    makeStandardSTXPostCondition(
      userAddress,
      FungibleConditionCode.Equal,
      ticketPrice
    )
  ],
  onFinish: (data) => {
    // Ticket minted successfully
    // NFT now in user's wallet
  }
});
```

---

## 2️⃣ CURRENT STATE ANALYSIS

### ✅ What Works
- **NFT Ticket Contract**: Implements SIP-009 standard
- **Transfer Function**: Exists in each event contract
- **Ownership Tracking**: Via `nft-get-owner?`
- **Marketplace Contracts**: 3 versions available

### ❌ What's Missing

#### A. **No Connection Between Ticket Contract & Marketplace**

**Problem:**
```clarity
;; Marketplace doesn't know about custom event contracts
(define-public (list-fixed-price 
  (nft-id uint) 
  (nft-contract principal)  ;; Generic principal
  (price uint)
)
  ;; No verification of ownership ❌
  ;; No check if ticket is valid ❌
  ;; No actual NFT transfer ❌
)
```

#### B. **No Actual Transfer in Buy Function**

**Current:**
```clarity
(define-public (buy-listing (listing-id uint))
  (let ((listing (unwrap! (map-get? listings listing-id) ERR-NOT-FOUND)))
    ;; Only records sale ❌
    (map-set sales sale-id {...})
    
    ;; No NFT transfer ❌
    ;; No STX payment ❌
  )
)
```

#### C. **No Ticket-Specific Validations**

Missing checks:
- ❌ Ticket not used/expired
- ❌ Event hasn't happened yet
- ❌ Ticket not in escrow/shared
- ❌ Organizer royalties

---

## 3️⃣ SECONDARY MARKET REQUIREMENTS

### User Stories

#### **Seller (Ticket Owner)**
```
As a ticket owner,
I want to list my ticket for resale,
So that I can recover costs if I can't attend

Acceptance Criteria:
- ✅ I own the ticket (verified on-chain)
- ✅ Ticket is valid (not used/expired)
- ✅ Event hasn't happened yet
- ✅ I set my resale price
- ✅ Marketplace holds ticket in escrow OR I approve transfer
```

#### **Buyer (Secondary Market)**
```
As a buyer,
I want to purchase a resold ticket,
So that I can attend sold-out events

Acceptance Criteria:
- ✅ See available tickets for resale
- ✅ Pay seller's asking price
- ✅ Platform fee deducted (2.5%)
- ✅ Organizer royalty paid (configurable %)
- ✅ Ticket transferred to my wallet immediately
- ✅ Cannot buy used/expired tickets
```

#### **Organizer (Royalties)**
```
As an event organizer,
I want to receive royalties on secondary sales,
So that I benefit from high-demand events

Acceptance Criteria:
- ✅ Set royalty % when creating event (0-10%)
- ✅ Receive payment automatically on resales
- ✅ Track secondary market volume
```

---

## 4️⃣ INTEGRATION IMPLEMENTATION

### Architecture

```
┌─────────────────────────────────────────────────────────┐
│                    FRONTEND LAYER                        │
├─────────────────────────────────────────────────────────┤
│  CreateEventNFT.tsx  →  Deploy Custom Event Contract    │
│  MintTicketButton.tsx →  Primary Sale (mint-ticket)      │
│  ResaleMarket.tsx    →  Secondary Market (NEW)          │
│  ListTicketButton.tsx →  List for resale (NEW)          │
└─────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────┐
│                  SMART CONTRACT LAYER                    │
├─────────────────────────────────────────────────────────┤
│  event-{name}.clar   →  Custom NFT + mint-ticket        │
│  nft-marketplace.clar →  Secondary market (NEEDS FIX)   │
│  integration.clar    →  Orchestration layer (NEW)       │
└─────────────────────────────────────────────────────────┘
```

### Key Integration Points

#### **1. List Ticket for Resale**

```typescript
// Frontend: ListTicketButton.tsx
async function listTicketForResale(
  eventContractId: string,
  tokenId: number,
  resalePrice: number
) {
  await openContractCall({
    contractAddress: MARKETPLACE_ADDRESS,
    contractName: 'nft-marketplace-v2',
    functionName: 'list-ticket-for-resale',
    functionArgs: [
      uintCV(tokenId),
      principalCV(eventContractId),
      uintCV(resalePrice)
    ]
  });
}
```

```clarity
;; Smart Contract: nft-marketplace-v2.clar
(define-public (list-ticket-for-resale
  (token-id uint)
  (ticket-contract principal)
  (resale-price uint)
)
  (let (
    (owner (unwrap! (contract-call? ticket-contract get-owner token-id) ERR-NOT-FOUND))
    (ticket-data (contract-call? ticket-contract get-ticket-data token-id))
    (listing-id (+ (var-get listing-nonce) u1))
  )
    ;; 1. Verify ownership
    (asserts! (is-eq (some tx-sender) owner) ERR-NOT-AUTHORIZED)
    
    ;; 2. Verify ticket validity (if ticket-contract supports it)
    ;; (asserts! (not (get is-used ticket-data)) ERR-TICKET-USED)
    
    ;; 3. Verify event hasn't happened
    ;; (asserts! (> (get event-date ticket-data) block-height) ERR-EVENT-ENDED)
    
    ;; 4. Create listing
    (map-set listings listing-id {
      nft-id: token-id,
      nft-contract: ticket-contract,
      seller: tx-sender,
      price: resale-price,
      listing-type: u"fixed",
      created-at: block-height,
      is-active: true,
      ;; Store ticket metadata for validation
      event-date: (get event-date ticket-data),
      organizer: (get organizer ticket-data),
      royalty-percentage: (get royalty-percentage ticket-data)
    })
    
    (var-set listing-nonce listing-id)
    (ok listing-id)
  )
)
```

#### **2. Buy Resale Ticket**

```typescript
// Frontend: ResaleMarket.tsx
async function buyResaleTicket(
  listingId: number,
  price: number
) {
  await openContractCall({
    contractAddress: MARKETPLACE_ADDRESS,
    contractName: 'nft-marketplace-v2',
    functionName: 'buy-resale-ticket',
    functionArgs: [uintCV(listingId)],
    postConditions: [
      makeStandardSTXPostCondition(
        userAddress,
        FungibleConditionCode.Equal,
        price
      )
    ]
  });
}
```

```clarity
;; Smart Contract: nft-marketplace-v2.clar
(define-public (buy-resale-ticket (listing-id uint))
  (let (
    (listing (unwrap! (map-get? listings listing-id) ERR-NOT-FOUND))
    (seller (get seller listing))
    (price (get price listing))
    (nft-contract (get nft-contract listing))
    (token-id (get nft-id listing))
    (royalty-pct (get royalty-percentage listing))
    (organizer (get organizer listing))
    
    ;; Calculate fees
    (platform-fee (/ (* price PLATFORM-FEE) u10000))
    (royalty (/ (* price royalty-pct) u10000))
    (seller-amount (- price (+ platform-fee royalty)))
  )
    ;; 1. Verify listing active
    (asserts! (get is-active listing) ERR-NOT-ACTIVE)
    
    ;; 2. Verify event hasn't happened
    (asserts! (> (get event-date listing) block-height) ERR-EVENT-ENDED)
    
    ;; 3. Transfer NFT from seller to buyer
    (try! (contract-call? nft-contract transfer token-id seller tx-sender))
    
    ;; 4. Distribute payments
    ;; To seller
    (try! (stx-transfer? seller-amount tx-sender seller))
    
    ;; To platform
    (try! (stx-transfer? platform-fee tx-sender CONTRACT-OWNER))
    
    ;; To organizer (royalty)
    (if (> royalty u0)
      (try! (stx-transfer? royalty tx-sender organizer))
      true
    )
    
    ;; 5. Record sale
    (map-set sales (+ (var-get listing-nonce) u1) {
      nft-id: token-id,
      seller: seller,
      buyer: tx-sender,
      price: price,
      sold-at: block-height,
      platform-fee: platform-fee,
      royalty-paid: royalty
    })
    
    ;; 6. Deactivate listing
    (map-set listings listing-id (merge listing {is-active: false}))
    
    ;; 7. Update stats
    (var-set total-volume (+ (var-get total-volume) price))
    (var-set total-sales (+ (var-get total-sales) u1))
    
    (ok true)
  )
)
```

---

## 5️⃣ SMART CONTRACT FIXES

### File: `nft-marketplace-v2.clar`

**Changes Needed:**

1. **Add ticket-specific fields to listing**
2. **Add ownership verification**
3. **Add actual NFT transfer**
4. **Add payment distribution**
5. **Add royalty support**

See implementation in section 4 above.

### Enhanced Listing Map

```clarity
(define-map listings uint {
  nft-id: uint,
  nft-contract: principal,
  seller: principal,
  price: uint,
  listing-type: (string-utf8 10),
  created-at: uint,
  is-active: bool,
  
  ;; NEW: Ticket-specific fields
  event-date: uint,           ;; Validate event not passed
  organizer: principal,        ;; For royalty payments
  royalty-percentage: uint,    ;; 0-1000 (0-10%)
  ticket-metadata: (optional (string-utf8 256))
})
```

---

## 6️⃣ FRONTEND IMPLEMENTATION

### New Components Needed

#### **A. ListTicketButton.tsx**
```typescript
/**
 * Component for ticket owners to list their tickets for resale
 * - Check ownership
 * - Set resale price
 * - List on marketplace
 */
import { openContractCall } from '@stacks/connect';
import { uintCV, principalCV } from '@stacks/transactions';

export const ListTicketButton = ({ 
  eventContractId, 
  tokenId, 
  currentPrice 
}) => {
  const [resalePrice, setResalePrice] = useState(currentPrice);
  
  const handleList = async () => {
    await openContractCall({
      contractAddress: MARKETPLACE_CONTRACT,
      contractName: 'nft-marketplace-v2',
      functionName: 'list-ticket-for-resale',
      functionArgs: [
        uintCV(tokenId),
        principalCV(eventContractId),
        uintCV(resalePrice * 1000000) // Convert to uSTX
      ]
    });
  };
  
  return (
    <div>
      <input 
        type="number" 
        value={resalePrice}
        onChange={(e) => setResalePrice(e.target.value)}
      />
      <Button onClick={handleList}>List for Resale</Button>
    </div>
  );
};
```

#### **B. ResaleMarket.tsx**
```typescript
/**
 * Browse and buy tickets from secondary market
 * - Filter by event
 * - Sort by price
 * - Show ticket details
 */
export const ResaleMarket = () => {
  const [listings, setListings] = useState([]);
  
  useEffect(() => {
    // Fetch active listings from marketplace
    fetchActiveListings();
  }, []);
  
  const handleBuy = async (listingId: number, price: number) => {
    await openContractCall({
      contractAddress: MARKETPLACE_CONTRACT,
      contractName: 'nft-marketplace-v2',
      functionName: 'buy-resale-ticket',
      functionArgs: [uintCV(listingId)],
      postConditions: [
        makeStandardSTXPostCondition(
          userAddress,
          FungibleConditionCode.Equal,
          price
        )
      ]
    });
  };
  
  return (
    <div>
      {listings.map(listing => (
        <TicketCard 
          key={listing.id}
          listing={listing}
          onBuy={handleBuy}
        />
      ))}
    </div>
  );
};
```

#### **C. MyTickets.tsx (Enhanced)**
```typescript
/**
 * User's ticket portfolio
 * - View owned tickets
 * - List for resale
 * - Cancel listings
 * - Transfer tickets
 */
export const MyTickets = () => {
  const userAddress = getUserAddress();
  const [tickets, setTickets] = useState([]);
  
  useEffect(() => {
    // Fetch user's NFT tickets across all events
    fetchUserTickets(userAddress);
  }, [userAddress]);
  
  return (
    <div>
      {tickets.map(ticket => (
        <TicketCard 
          key={ticket.id}
          ticket={ticket}
          actions={
            <>
              <ListTicketButton {...ticket} />
              <TransferTicketButton {...ticket} />
              <ViewTicketDetails {...ticket} />
            </>
          }
        />
      ))}
    </div>
  );
};
```

---

## 🎯 IMPLEMENTATION CHECKLIST

### Phase 1: Smart Contract (Priority)
- [ ] Fix `nft-marketplace-v2.clar`
  - [ ] Add `list-ticket-for-resale` function
  - [ ] Add `buy-resale-ticket` function with full payment flow
  - [ ] Add ownership verification via `contract-call?`
  - [ ] Add ticket validity checks
  - [ ] Add royalty distribution
  - [ ] Add event-date validation

### Phase 2: Frontend Components
- [ ] Create `ListTicketButton.tsx`
- [ ] Create `ResaleMarket.tsx`
- [ ] Enhance `MyTickets.tsx`
- [ ] Add secondary market to navigation
- [ ] Add price history charts
- [ ] Add notifications for sales

### Phase 3: Integration
- [ ] Deploy updated marketplace contract
- [ ] Update event contracts to include royalty field
- [ ] Add marketplace approval to ticket contracts
- [ ] Test complete flow end-to-end

### Phase 4: Features
- [ ] Add offers system (buyers propose prices)
- [ ] Add auction system for high-demand tickets
- [ ] Add bundle sales (multiple tickets)
- [ ] Add price history & analytics
- [ ] Add automated fraud detection

---

## 🔄 COMPLETE USER JOURNEY

```
┌──────────────────────────────────────────────────────────────┐
│                    PRIMARY MARKET                             │
└──────────────────────────────────────────────────────────────┘
1. Organizer creates event (CreateEventNFT.tsx)
2. Event contract deployed with royalty %
3. Buyer mints ticket (MintTicketButton.tsx)
4. NFT transferred to buyer wallet
   ↓
┌──────────────────────────────────────────────────────────────┐
│                   TICKET OWNERSHIP                            │
└──────────────────────────────────────────────────────────────┘
5. User views "My Tickets" page
6. Sees owned ticket with event details
7. Decides to resell (can't attend)
   ↓
┌──────────────────────────────────────────────────────────────┐
│                  SECONDARY MARKET                             │
└──────────────────────────────────────────────────────────────┘
8. Click "List for Resale" (ListTicketButton.tsx)
9. Set resale price (can be higher/lower than original)
10. Sign transaction to list on marketplace
11. Ticket appears in ResaleMarket.tsx
    ↓
12. New buyer browses resale market
13. Finds ticket, clicks "Buy"
14. Pays: Seller Amount + Platform Fee + Royalty
15. NFT auto-transferred to new buyer
16. All parties receive payments instantly
    ↓
┌──────────────────────────────────────────────────────────────┐
│                  EVENT ACCESS                                 │
└──────────────────────────────────────────────────────────────┘
17. New owner uses ticket to attend event
18. QR code / NFC scanned at venue
19. Ticket marked as "used" on-chain
20. Cannot be resold after use
```

---

## 💰 PAYMENT DISTRIBUTION EXAMPLE

### Scenario:
- Original Price: $50 (primary sale)
- Resale Price: $100 (high demand!)
- Platform Fee: 2.5%
- Organizer Royalty: 5%

### Distribution:
```
Total Paid by Buyer: $100

├─ Seller (Original Ticket Holder): $92.50
├─ Platform (INTIC): $2.50 (2.5%)
└─ Organizer (Royalty): $5.00 (5%)

Total: $100 ✓
```

### On-Chain Calculation:
```clarity
(let (
  (price u100000000)           ;; $100 in uSTX
  (platform-fee u2500000)      ;; 2.5%
  (royalty u5000000)           ;; 5%
  (seller-amount u92500000)    ;; Remainder
)
  (try! (stx-transfer? seller-amount tx-sender seller))
  (try! (stx-transfer? platform-fee tx-sender platform-owner))
  (try! (stx-transfer? royalty tx-sender organizer))
)
```

---

## 🚀 NEXT STEPS

1. **Review this document** with team
2. **Implement smart contract fixes** (nft-marketplace-v2.clar)
3. **Create frontend components** (ListTicketButton, ResaleMarket)
4. **Test on testnet** with real flow
5. **Deploy to mainnet** when ready

---

## 📞 SUPPORT

For questions or issues:
- GitHub: edison-alpha/intic-id
- Documentation: /docs
- Contract Address: (deploy and update here)

---

**Last Updated:** October 19, 2025
**Version:** 1.0.0
**Status:** 🟡 Implementation Required
